<script>
const screenCalc = document.getElementById('screen-calc');
const screenLog = document.getElementById('screen-log');
const screenSettings = document.getElementById('screen-settings');

const tabCalc = document.getElementById('tabCalc');
const tabLog = document.getElementById('tabLog');
const tabSettings = document.getElementById('tabSettings');

const saveBtn = document.getElementById('save');
const exportPdf = document.getElementById('exportPdf');
const exportCal = document.getElementById('exportCal');
const clearData = document.getElementById('clearData');
const log = document.getElementById('log');

const WEEKLY_HOURS = 40;
const STORE_KEY = 'police_ot_entries';

const PAY = {
  met: {PC: {1:31646,2:32472,3:33789,4:35106,5:37737,6:43038,7:50256}, PS: {2:53568,3:54660,4:56208}},
  other: {PC: {1:31646,2:32472,3:33789,4:35106,5:37737,6:43038,7:50256}, PS: {2:53568,3:54660,4:56208}}
};

const force = document.getElementById('force');
const rank = document.getElementById('rank');
const point = document.getElementById('point');
const warrant = document.getElementById('warrant');
const hours = document.getElementById('hours');
const startTime = document.getElementById('startTime');
const finishTime = document.getElementById('finishTime');
const otType = document.getElementById('otType');
const dateEl = document.getElementById('date');

const baseEl = document.getElementById('base');
const otEl = document.getElementById('ot');
const grossEl = document.getElementById('gross');
const dedEl = document.getElementById('ded');
const netEl = document.getElementById('net');

// Load ranks based on selected force
function loadRanks(){
  rank.innerHTML = '';
  Object.keys(PAY[force.value]).forEach(r => rank.add(new Option(r, r)));
  loadPoints();
}

// Load pay points based on rank
function loadPoints(){
  point.innerHTML = '';
  Object.keys(PAY[force.value][rank.value]).forEach(p => point.add(new Option(p, p)));
  calculate();
}

// Calculate hours and pay
function calculate(){
  if(startTime.value && finishTime.value){
    const [sh, sm] = startTime.value.split(':').map(Number);
    const [fh, fm] = finishTime.value.split(':').map(Number);

    let startMinutes = sh*60 + sm;
    let finishMinutes = fh*60 + fm;

    if(finishMinutes < startMinutes){
      finishMinutes += 24*60; // overnight shift
    }

    const diffHours = (finishMinutes - startMinutes) / 60;
    hours.value = diffHours.toFixed(2);
  }

  const annual = PAY[force.value]?.[rank.value]?.[point.value];
  if(!annual) return;

  const base = annual / 52 / WEEKLY_HOURS;
  const ot = base * Number(otType.value);
  const hrs = Number(hours.value) || 0;
  const gross = ot * hrs;
  const higher = annual > 50270;
  const taxNI = gross * ((higher ? 0.4 : 0.2) + (higher ? 0.02 : 0.08));
  const net = gross - taxNI;

  baseEl.textContent = base.toFixed(2);
  otEl.textContent = ot.toFixed(2);
  grossEl.textContent = gross.toFixed(2);
  dedEl.textContent = taxNI.toFixed(2);
  netEl.textContent = net.toFixed(2);

  return {hrs, gross, net};
}

// LocalStorage helpers
function getEntries(){ return JSON.parse(localStorage.getItem(STORE_KEY) || '[]'); }
function setEntries(e){ localStorage.setItem(STORE_KEY, JSON.stringify(e)); }

// Save Overtime
saveBtn.onclick = () => {
  if(!dateEl.value) return alert('Please select a date');
  const calc = calculate();
  if(!calc) return;

  const entry = {
    date: dateEl.value,
    hours: calc.hrs,
    net: calc.net,
    rank: rank.value,
    point: point.value,
    warrant: warrant.value
  };

  const all = getEntries();
  all.push(entry);
  setEntries(all);
  renderLog();
};

// Render log
function renderLog(){
  log.innerHTML = '';
  getEntries().forEach(e => {
    log.innerHTML += `<div class="entry">${e.date} • ${e.rank} PP${e.point} • ${e.hours}h • £${e.net.toFixed(2)}</div>`;
  });
}

// Export Calendar
exportCal.onclick = () => {
  const entries = getEntries();
  if(!entries.length) return alert('No entries to export');

  const now = new Date().toISOString().replace(/[-:]/g,'').split('.')[0];

  let ics = `BEGIN:VCALENDAR\r
VERSION:2.0\r
PRODID:-//Police OT//EN\r
`;

  entries.forEach((e,i)=>{
    if(!e.date) return;
    const d = new Date(e.date).toISOString().replace(/[-:]/g,'').split('.')[0];
    ics += `BEGIN:VEVENT\r
UID:police-ot-${i}-${d}@local\r
DTSTAMP:${now}Z\r
DTSTART;VALUE=DATE:${d.slice(0,8)}\r
SUMMARY:Police OT ${e.hours}h\r
END:VEVENT\r
`;
  });

  ics += 'END:VCALENDAR';

  const blob = new Blob([ics], {type:'text/calendar;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'police-overtime.ics';
  a.click();
  URL.revokeObjectURL(a.href);
};

// Placeholder for PDF export
exportPdf.onclick = () => alert('PDF export coming next drop');

// Clear data
clearData.onclick = () => {
  if(confirm('Clear all data?')){
    localStorage.removeItem(STORE_KEY);
    renderLog();
  }
};

// Screen switching
function switchScreen(s){
  screenCalc.style.display = s==='calc'?'block':'none';
  screenLog.style.display = s==='log'?'block':'none';
  screenSettings.style.display = s==='settings'?'block':'none';
  tabCalc.classList.toggle('active', s==='calc');
  tabLog.classList.toggle('active', s==='log');
  tabSettings.classList.toggle('active', s==='settings');
}

tabCalc.onclick = () => switchScreen('calc');
tabLog.onclick = () => switchScreen('log');
tabSettings.onclick = () => switchScreen('settings');

// Event listeners
force.onchange = loadRanks;
rank.onchange = loadPoints;
point.onchange = calculate;
startTime.oninput = calculate;
finishTime.oninput = calculate;
otType.onchange = calculate;

// Initialize
dateEl.valueAsDate = new Date();
loadRanks();
renderLog();
</script>
