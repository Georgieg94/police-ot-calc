<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Police Overtime Calculator</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial;margin:0;background:#f2f2f7}
    .card{max-width:480px;margin:16px auto;background:#fff;border-radius:16px;padding:16px;box-shadow:0 10px 25px rgba(0,0,0,.08)}
    h1,h2{margin:8px 0;text-align:center}
    label{font-weight:600;margin-top:12px;display:block}
    input,select,button{width:100%;padding:12px;margin-top:6px;border-radius:12px;border:1px solid #ddd;font-size:1rem}
    button{background:#0a84ff;color:#fff;border:none;font-weight:700}
    .row{display:flex;justify-content:space-between;margin:6px 0}
    .result{background:#f5f5f7;border-radius:12px;padding:12px;margin-top:12px}
    .entry{background:#fff;border-radius:12px;padding:10px;margin-top:8px}
  </style>
</head>
<body>

<div class="card">
  <h1>Police OT</h1>

  <label>Warrant Number</label>
  <input id="warrant" placeholder="123456">

  <label>Force</label>
  <select id="force">
    <option value="met">Metropolitan Police</option>
    <option value="other">Other Force</option>
  </select>

  <label>Rank</label>
  <select id="rank"></select>

  <label>Pay Point</label>
  <select id="point"></select>

  <label>Date</label>
  <input type="date" id="date">

  <label>Hours</label>
  <input type="number" id="hours" value="9">

  <label>OT Type</label>
  <select id="otType">
    <option value="1.3333">Standard (1⅓)</option>
    <option value="1.5">Rest Day (1½)</option>
    <option value="2">Cancelled RD (Double)</option>
  </select>

  <div class="result">
    <div class="row"><span>Base hourly</span><strong>£<span id="base">0.00</span></strong></div>
    <div class="row"><span>OT hourly</span><strong>£<span id="ot">0.00</span></strong></div>
    <div class="row"><span>Gross</span><strong>£<span id="gross">0.00</span></strong></div>
    <div class="row"><span>Tax & NI</span><strong>£<span id="ded">0.00</span></strong></div>
    <div class="row"><span>Net</span><strong>£<span id="net">0.00</span></strong></div>
  </div>

  <button id="save">Save Overtime</button>
</div>

<div class="card">
  <h2>Overtime Log</h2>
  <select id="viewMode">
    <option value="day">By Day</option>
    <option value="week">By Week</option>
    <option value="month">By Month</option>
    <option value="year">By Year</option>
  </select>
  <div id="log"></div>
</div>

<div class="card">
  <h2>Totals</h2>
  <div class="row"><span>This Month</span><strong>£<span id="monthTotal">0.00</span></strong></div>
  <div class="row"><span>This Year</span><strong>£<span id="yearTotal">0.00</span></strong></div>
</div>

<div class="card">
  <h2>Claim Export</h2>
  <button id="exportPdf">Export PDF Claim</button>
</div>

<script>
const WEEKLY_HOURS = 40;
const STORE_KEY = 'police_ot_entries';

const PAY = {
  met:{PC:{1:31646,2:32472,3:33789,4:35106,5:37737,6:43038,7:50256},PS:{2:53568,3:54660,4:56208}},
  other:{PC:{1:31646,2:32472,3:33789,4:35106,5:37737,6:43038,7:50256},PS:{2:53568,3:54660,4:56208}}
};

const force = document.getElementById('force');
const rank = document.getElementById('rank');
const point = document.getElementById('point');
const hours = document.getElementById('hours');
const otType = document.getElementById('otType');
const dateEl = document.getElementById('date');
const viewMode = document.getElementById('viewMode');

const baseEl = document.getElementById('base');
const otEl = document.getElementById('ot');
const grossEl = document.getElementById('gross');
const dedEl = document.getElementById('ded');
const netEl = document.getElementById('net');
const log = document.getElementById('log');
const monthTotalEl = document.getElementById('monthTotal');
const yearTotalEl = document.getElementById('yearTotal');

/* ===== PAY LOADERS ===== */
function loadRanks(){
  rank.innerHTML='';
  Object.keys(PAY[force.value]).forEach(r=>rank.add(new Option(r,r)));
  loadPoints();
}

function loadPoints(){
  point.innerHTML='';
  Object.keys(PAY[force.value][rank.value]).forEach(p=>point.add(new Option(p,p)));
  calculate();
}

/* ===== CALCULATION ===== */
function calculate(){
  const annual = PAY[force.value][rank.value][point.value];
  if(!annual) return null;
  const base = annual / 52 / WEEKLY_HOURS;
  const ot = base * Number(otType.value);
  const hrs = Number(hours.value)||0;
  const gross = ot * hrs;
  const higher = annual > 50270;
  const taxNI = gross * ((higher?0.4:0.2)+(higher?0.02:0.08));
  const net = gross - taxNI;
  baseEl.textContent = base.toFixed(2);
  otEl.textContent = ot.toFixed(2);
  grossEl.textContent = gross.toFixed(2);
  dedEl.textContent = taxNI.toFixed(2);
  netEl.textContent = net.toFixed(2);
  return {net, gross, hrs};
}

/* ===== STORAGE ===== */
function getEntries(){return JSON.parse(localStorage.getItem(STORE_KEY)||'[]');}
function setEntries(e){localStorage.setItem(STORE_KEY,JSON.stringify(e));}

/* ===== RECEIPTS ===== */
const receiptInput = document.createElement('input');
receiptInput.type='file';
receiptInput.accept='image/*';
receiptInput.capture='environment';

function fileToBase64(file){
  return new Promise(res=>{
    const r=new FileReader();
    r.onload=()=>res(r.result);
    r.readAsDataURL(file);
  });
}

const receiptBtn = document.createElement('button');
receiptBtn.textContent='Attach Receipt';
receiptBtn.onclick=()=>receiptInput.click();

/* ===== SAVE OT ===== */
save.onclick = async()=>{
  const c = calculate();
  if(!c) return;
  let receipt=null;
  if(receiptInput.files[0]) receipt = await fileToBase64(receiptInput.files[0]);
  const all = getEntries();
  all.push({date:dateEl.value,hours:c.hrs,gross:c.gross,net:c.net,receipt});
  setEntries(all);
  receiptInput.value='';
  render();
};

/* ===== GROUPED LOG + TOTALS ===== */
function groupKey(d){
  if(viewMode.value==='day') return d.toLocaleDateString();
  if(viewMode.value==='week'){
    const start=new Date(d);start.setDate(d.getDate()-d.getDay());
    return 'Week of '+start.toLocaleDateString();
  }
  if(viewMode.value==='month') return d.toLocaleString('default',{month:'long',year:'numeric'});
  return d.getFullYear();
}

function render(){
  log.innerHTML='';
  const entries=getEntries();
  const grouped={};
  const now=new Date();
  let m=0,y=0;

  entries.forEach(e=>{
    const d=new Date(e.date);
    const k=groupKey(d);
    grouped[k]??={h:0,n:0,items:[]};
    grouped[k].h+=e.hours;
    grouped[k].n+=e.net;
    grouped[k].items.push(e);
    if(d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear())m+=e.net;
    if(d.getFullYear()===now.getFullYear())y+=e.net;
  });

  Object.keys(grouped).forEach(k=>{
    log.innerHTML+=`<div class='entry'><strong>${k}</strong><br>${grouped[k].h}h • £${grouped[k].n.toFixed(2)}</div>`;
    grouped[k].items.forEach(i=>{
      log.innerHTML+=`<div class='entry'>${i.date} • ${i.hours}h • £${i.net.toFixed(2)}${i.receipt?`<br><img src='${i.receipt}' style='width:90px;border-radius:8px'>`:''}</div>`;
    });
  });

  monthTotalEl.textContent=m.toFixed(2);
  yearTotalEl.textContent=y.toFixed(2);
}

/* ===== CALENDAR EXPORT ===== */
function exportCalendar(){
  const entries=getEntries();
  if(!entries.length){alert('No overtime');return;}
  let ics='BEGIN:VCALENDAR
VERSION:2.0
';
  entries.forEach(e=>{
    const d=new Date(e.date).toISOString().replace(/[-:]/g,'').split('.')[0];
    ics+=`BEGIN:VEVENT
DTSTART:${d}
SUMMARY:Police Overtime (${e.hours}h)
DESCRIPTION:Net £${e.net.toFixed(2)}
END:VEVENT
`;
  });
  ics+='END:VCALENDAR';
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([ics],{type:'text/calendar'}));
  a.download='police-overtime.ics';
  a.click();
}

const calBtn=document.createElement('button');
calBtn.textContent='Export to Calendar';
calBtn.onclick=exportCalendar;

/* ===== INIT ===== */
force.onchange=loadRanks;
rank.onchange=loadPoints;
hours.oninput=calculate;
otType.onchange=calculate;
viewMode.onchange=render;
dateEl.valueAsDate=new Date();
loadRanks();
render();

save.after(receiptBtn);
receiptBtn.after(calBtn);
</script>
</body>
</html>
