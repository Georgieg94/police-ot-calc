<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Police Overtime Calculator</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial;margin:0;background:#f2f2f7}
    .card{max-width:480px;margin:16px auto;background:#fff;border-radius:16px;padding:16px;box-shadow:0 10px 25px rgba(0,0,0,.08)}
    h1,h2{margin:8px 0;text-align:center}
    label{font-weight:600;margin-top:12px;display:block}
    input,select,button{width:100%;padding:12px;margin-top:6px;border-radius:12px;border:1px solid #ddd;font-size:1rem}
    button{background:#0a84ff;color:#fff;border:none;font-weight:700}
    button.secondary{background:#e5e5ea;color:#000}
    button.danger{background:#ff3b30}
    .row{display:flex;justify-content:space-between;margin:6px 0}
    .result{background:#f5f5f7;border-radius:12px;padding:12px;margin-top:12px}
    .entry{background:#fff;border-radius:12px;padding:10px;margin-top:8px}
    .actions{display:flex;gap:8px;margin-top:6px}
    img.thumb{width:60px;border-radius:10px;margin-top:6px}
  </style>
</head>
<body>

<div class="card">
  <h1>Police OT</h1>

  <label>Warrant Number</label>
  <input id="warrant" placeholder="123456">

  <label>Force</label>
  <select id="force">
    <option value="met">Metropolitan Police</option>
    <option value="other">Other Force</option>
  </select>

  <label>Rank</label>
  <select id="rank"></select>

  <label>Pay Point</label>
  <select id="point"></select>

  <label>Date</label>
  <input type="date" id="date">

  <label>Hours</label>
  <input type="number" id="hours" value="9">

  <label>OT Type</label>
  <select id="otType">
    <option value="1.3333">Standard (1⅓)</option>
    <option value="1.5">Rest Day (1½)</option>
    <option value="2">Cancelled RD (Double)</option>
  </select>

  <label>Attach Receipt</label>
  <input type="file" id="receipt" accept="image/*" capture="environment">

  <div class="result">
    <div class="row"><span>Base hourly</span><strong>£<span id="base">0.00</span></strong></div>
    <div class="row"><span>OT hourly</span><strong>£<span id="ot">0.00</span></strong></div>
    <div class="row"><span>Gross</span><strong>£<span id="gross">0.00</span></strong></div>
    <div class="row"><span>Tax & NI</span><strong>£<span id="ded">0.00</span></strong></div>
    <div class="row"><span>Net</span><strong>£<span id="net">0.00</span></strong></div>
  </div>

  <button id="save">Save Overtime</button>
</div>

<div class="card">
  <h2>Overtime Log</h2>

  <label>View</label>
  <select id="viewMode">
    <option value="day">By Day</option>
    <option value="week">By Week</option>
    <option value="month">By Month</option>
    <option value="year">By Year</option>
  </select>

  <div id="log"></div>
</div>

<div class="card">
  <h2>Claim Export</h2>
  <button id="exportPdf">Export PDF Claim</button>
</div>

<script>
const WEEKLY_HOURS = 40;
const STORE_KEY = 'police_ot_entries';
let editIndex = null;

const PAY = {
  met:{PC:{1:31646,2:32472,3:33789,4:35106,5:37737,6:43038,7:50256},PS:{2:53568,3:54660,4:56208}},
  other:{PC:{1:31646,2:32472,3:33789,4:35106,5:37737,6:43038,7:50256},PS:{2:53568,3:54660,4:56208}}
};

const force = force;
const rank = rank;
const point = point;
const hours = hours;
const otType = otType;
const receipt = document.getElementById('receipt');

const baseEl = base;
const otEl = ot;
const grossEl = gross;
const dedEl = ded;
const netEl = net;

function loadRanks(){rank.innerHTML='';Object.keys(PAY[force.value]).forEach(r=>rank.add(new Option(r,r)));loadPoints();}
function loadPoints(){point.innerHTML='';Object.keys(PAY[force.value][rank.value]).forEach(p=>point.add(new Option(p,p)));calculate();}

function calculate(){
  const annual = PAY[force.value][rank.value][point.value];
  if(!annual) return null;
  const base = annual / 52 / WEEKLY_HOURS;
  const ot = base * Number(otType.value);
  const hrs = Number(hours.value)||0;
  const gross = ot * hrs;
  const higher = annual > 50270;
  const taxNI = gross * ((higher?0.4:0.2)+(higher?0.02:0.08));
  const net = gross - taxNI;
  baseEl.textContent = base.toFixed(2);
  otEl.textContent = ot.toFixed(2);
  grossEl.textContent = gross.toFixed(2);
  dedEl.textContent = taxNI.toFixed(2);
  netEl.textContent = net.toFixed(2);
  return net;
}

function getEntries(){return JSON.parse(localStorage.getItem(STORE_KEY)||'[]');}
function saveEntries(e){localStorage.setItem(STORE_KEY,JSON.stringify(e));}

function fileToBase64(file){return new Promise(r=>{const fr=new FileReader();fr.onload=()=>r(fr.result);fr.readAsDataURL(file);});}

save.onclick = async()=>{
  const net = calculate();
  if(net===null) return;
  let receiptData = null;
  if(receipt.files[0]) receiptData = await fileToBase64(receipt.files[0]);
  const entry = {date:date.value,hours:Number(hours.value),net,receipt:receiptData};
  const all = getEntries();
  if(editIndex!==null){all[editIndex]=entry;editIndex=null;} else all.push(entry);
  saveEntries(all);
  receipt.value='';
  render();
};

function render(){
  const entries = getEntries();
  log.innerHTML = '';

  const now = new Date();
  let monthTotal = 0;
  let yearTotal = 0;

  const groups = {};

  entries.forEach(e => {
    const d = new Date(e.date);
    if(d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) monthTotal += e.net;
    if(d.getFullYear() === now.getFullYear()) yearTotal += e.net;

    let key;
    switch(viewMode.value){
      case 'week':
        const first = new Date(d.getFullYear(),0,1);
        key = d.getFullYear() + ' W' + Math.ceil((((d - first) / 86400000) + first.getDay() + 1) / 7);
        break;
      case 'month': key = d.toLocaleString('default',{month:'long',year:'numeric'}); break;
      case 'year': key = d.getFullYear(); break;
      default: key = e.date;
    }

    groups[key] = (groups[key] || 0) + e.net;
  });

  Object.keys(groups).forEach(k => {
    log.innerHTML += `<div class='entry'><strong>${k}</strong><br>£${groups[k].toFixed(2)}</div>`;
  });

  monthTotalEl.textContent = monthTotal.toFixed(2);
  yearTotalEl.textContent = yearTotal.toFixed(2);
} • ${e.hours}h • £${e.net.toFixed(2)}${e.receipt?`<br><img class='thumb' src='${e.receipt}'>`:''}<div class='actions'><button class='secondary' onclick='editEntry(${i})'>Edit</button><button class='danger' onclick='deleteEntry(${i})'>Delete</button></div></div>`;
  });
}

function editEntry(i){const e=getEntries()[i];editIndex=i;date.value=e.date;hours.value=e.hours;netEl.textContent=e.net;}
function deleteEntry(i){if(!confirm('Delete entry?'))return;const all=getEntries();all.splice(i,1);saveEntries(all);render();}

function exportPDF(){
  const entries = getEntries();
  if(!entries.length){ alert('No overtime to export'); return; }
  const win = window.open('', '_blank');
  win.document.write(`<h1>${force.options[force.selectedIndex].text}</h1><p>Warrant: ${warrant.value}</p><table border='1' width='100%'><tr><th>Date</th><th>Hours</th><th>Net</th></tr>`);
  let total=0;
  entries.forEach(e=>{total+=e.net;win.document.write(`<tr><td>${e.date}</td><td>${e.hours}</td><td>£${e.net.toFixed(2)}</td></tr>`);if(e.receipt)win.document.write(`<tr><td colspan='3'><img src='${e.receipt}' width='300'></td></tr>`);});
  win.document.write(`<tr><th colspan='2'>Total</th><th>£${total.toFixed(2)}</th></tr></table>`);
  win.print();
}

exportPdf.onclick = exportPDF;

/* ===== DROP 7: CALENDAR EXPORT (ICS) ===== */
function exportCalendar(){
  const entries = getEntries();
  if(!entries.length){ alert('No overtime to export'); return; }

  let ics = 'BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Police OT//EN
';

  entries.forEach(e=>{
    const d = new Date(e.date);
    const dt = d.toISOString().replace(/[-:]/g,'').split('.')[0];
    const summary = 'Police Overtime';
    const desc = `Hours: ${e.hours}\nNet: £${e.net.toFixed(2)}`;

    ics += 'BEGIN:VEVENT
';
    ics += `DTSTART:${dt}
`;
    ics += `DTEND:${dt}
`;
    ics += `SUMMARY:${summary}
`;
    ics += `DESCRIPTION:${desc}
`;
    ics += 'END:VEVENT
';
  });

  ics += 'END:VCALENDAR';

  const blob = new Blob([ics], { type: 'text/calendar' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'police-overtime.ics';
  a.click();
}

const calBtn = document.createElement('button');
calBtn.textContent = 'Add OT to Calendar';
calBtn.onclick = exportCalendar;
document.querySelector('.card:last-of-type').prepend(calBtn);
force.onchange=loadRanks;rank.onchange=loadPoints;hours.oninput=calculate;otType.onchange=calculate;
date.valueAsDate=new Date();loadRanks();render();
</script>
</body>
</html>
