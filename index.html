<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Police Overtime Calculator</title>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial;
  margin:0;
  background:#f2f2f7;
}
nav{
  position:fixed;
  top:0;left:0;right:0;
  background:#003a8f;
  display:flex;
  z-index:1000;
}
nav button{
  flex:1;
  padding:14px 0;
  border:none;
  background:#003a8f;
  color:#fff;
  font-weight:700;
}
nav button.active{
  background:#fff;
  color:#003a8f;
}
.card{
  max-width:430px;
  margin:72px auto 24px;
  background:#fff;
  border-radius:16px;
  padding:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
}
label{
  font-weight:600;
  font-size:.9rem;
  margin-bottom:4px;
  display:block;
}
input,select,button{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid #ddd;
  font-size:.95rem;
  box-sizing:border-box;
}
button{
  background:#003a8f;
  color:#fff;
  border:none;
  font-weight:700;
  margin-top:12px;
}
button.secondary{background:#003a8f;}
button.danger{background:#ff3b30;}

.field{margin-top:10px;}
.field-row{
  display:flex;
  gap:8px;
  margin-top:10px;
}
.field-row .field{flex:1;margin-top:0;}

.result{
  background:#f5f5f7;
  border-radius:12px;
  padding:12px;
  margin-top:12px;
}
.row{
  display:flex;
  justify-content:space-between;
  margin:6px 0;
}
.entry{
  background:#fff;
  border-radius:12px;
  padding:10px;
  margin-top:8px;
}
.entry-actions{
  display:flex;
  gap:8px;
  margin-top:6px;
}
.entry-actions button{margin-top:0;}
</style>
</head>

<body>

<nav>
  <button id="tabCalc" class="active">Calc</button>
  <button id="tabLog">Log</button>
  <button id="tabSettings">Settings</button>
</nav>

<!-- CALC SCREEN -->
<div class="card" id="screen-calc">
<h1 style="text-align:center">Police OT</h1>

<div class="field">
  <label>Force</label>
  <select id="force">
    <option value="met">Metropolitan Police</option>
    <option value="other">Other Home Office Force</option>
  </select>
</div>

<div class="field-row">
  <div class="field">
    <label>Rank</label>
    <select id="rank"></select>
  </div>
  <div class="field">
    <label>Pay Point</label>
    <select id="point"></select>
  </div>
</div>

<div class="field">
  <label>Warrant Number</label>
  <input id="warrant" placeholder="123456">
</div>

<div class="field">
  <label>Date</label>
  <input type="date" id="date">
</div>

<div class="field-row">
  <div class="field">
    <label>Start</label>
    <input type="time" id="startTime">
  </div>
  <div class="field">
    <label>Finish</label>
    <input type="time" id="finishTime">
  </div>
</div>

<div class="field">
  <label>Hours (auto)</label>
  <input id="hours" readonly>
</div>

<div class="field">
  <label>OT Type</label>
  <select id="otType">
    <option value="1.3333">Standard (1⅓)</option>
    <option value="1.5">Rest Day (1½)</option>
    <option value="2">Cancelled RD (Double)</option>
  </select>
</div>

<div class="field">
  <label>Attach Receipt</label>
  <input type="file" id="receipt" accept="image/*" capture="environment">
</div>

<div class="result">
  <div class="row"><span>Base</span><strong>£<span id="base">0.00</span></strong></div>
  <div class="row"><span>OT</span><strong>£<span id="ot">0.00</span></strong></div>
  <div class="row"><span>Gross</span><strong>£<span id="gross">0.00</span></strong></div>
  <div class="row"><span>Tax & NI</span><strong>£<span id="ded">0.00</span></strong></div>
  <div class="row"><span>Net</span><strong>£<span id="net">0.00</span></strong></div>
</div>

<button id="save">Save Overtime</button>
<button id="exportPdf" class="secondary">Export Claim PDF</button>
<button id="exportCal" class="secondary">Export to Calendar</button>
</div>

<!-- LOG SCREEN -->
<div class="card" id="screen-log" style="display:none">
<h2>Overtime Log</h2>
<div id="log"></div>
</div>

<!-- SETTINGS -->
<div class="card" id="screen-settings" style="display:none">
<h2>Settings</h2>
<button class="danger" id="clearData">Clear All Data</button>
</div>

<script>
const STORE_KEY='police_ot_entries';
const WEEKLY_HOURS=40;

const PAY={
  met:{PC:{1:31646,2:32472,3:33789,4:35106,5:37737,6:43038,7:50256},PS:{2:53568,3:54660,4:56208}},
  other:{PC:{1:31646,2:32472,3:33789,4:35106,5:37737,6:43038,7:50256},PS:{2:53568,3:54660,4:56208}}
};

const $=id=>document.getElementById(id);

function loadRanks(){
  rank.innerHTML='';
  Object.keys(PAY[force.value]).forEach(r=>rank.add(new Option(r,r)));
  loadPoints();
}
function loadPoints(){
  point.innerHTML='';
  Object.keys(PAY[force.value][rank.value]).forEach(p=>point.add(new Option(p,p)));
  calculate();
}

function calculate(){
  if(startTime.value&&finishTime.value){
    const [sh,sm]=startTime.value.split(':').map(Number);
    const [fh,fm]=finishTime.value.split(':').map(Number);
    let diff=(fh+fm/60)-(sh+sm/60);
    if(diff<0) diff+=24;
    hours.value=diff.toFixed(2);
  }
  const annual=PAY[force.value][rank.value][point.value];
  if(!annual) return null;
  const base=annual/52/WEEKLY_HOURS;
  const ot=base*Number(otType.value);
  const hrs=Number(hours.value)||0;
  const gross=ot*hrs;
  const higher=annual>50270;
  const ded=gross*((higher?0.4:0.2)+(higher?0.02:0.08));
  const net=gross-ded;
  base.textContent=base.toFixed(2);
  otEl.textContent=ot.toFixed(2);
  grossEl.textContent=gross.toFixed(2);
  dedEl.textContent=ded.toFixed(2);
  netEl.textContent=net.toFixed(2);
  return {hrs,net};
}

function getEntries(){return JSON.parse(localStorage.getItem(STORE_KEY)||'[]');}
function setEntries(e){localStorage.setItem(STORE_KEY,JSON.stringify(e));}

async function fileToBase64(f){
  return new Promise(r=>{const fr=new FileReader();fr.onload=()=>r(fr.result);fr.readAsDataURL(f);});
}

save.onclick=async()=>{
  const calc=calculate();
  if(!calc) return;
  let receipt=null;
  if(receiptInput.files[0]) receipt=await fileToBase64(receiptInput.files[0]);
  const all=getEntries();
  all.push({
    date:dateEl.value,
    hours:calc.hrs,
    net:calc.net,
    rank:rank.value,
    point:point.value,
    warrant:warrant.value,
    receipt
  });
  setEntries(all);
  receiptInput.value='';
  renderLog();
};

function deleteEntry(i){
  const e=getEntries();
  e.splice(i,1);
  setEntries(e);
  renderLog();
}

function renderLog(){
  log.innerHTML='';
  getEntries().forEach((e,i)=>{
    log.innerHTML+=`
    <div class="entry">
      ${e.date} • ${e.rank} PP${e.point} • ${e.hours}h • £${e.net.toFixed(2)}
      <div class="entry-actions">
        <button class="danger" onclick="deleteEntry(${i})">Delete</button>
      </div>
    </div>`;
  });
}

exportCal.onclick=()=>{
  const e=getEntries();
  if(!e.length) return alert('No entries');
  let ics='BEGIN:VCALENDAR\nVERSION:2.0\n';
  e.forEach(x=>{
    const d=new Date(x.date).toISOString().replace(/[-:]/g,'').split('.')[0];
    ics+=`BEGIN:VEVENT\nDTSTART:${d}\nSUMMARY:Police OT ${x.hours}h\nEND:VEVENT\n`;
  });
  ics+='END:VCALENDAR';
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([ics],{type:'text/calendar'}));
  a.download='police-ot.ics';
  a.click();
};

exportPdf.onclick=()=>{
  const e=getEntries();
  if(!e.length) return alert('No entries');
  const w=window.open('','_blank');
  w.document.write('<h1>Police OT Claim</h1>');
  w.document.write(`<p>Force: ${force.options[force.selectedIndex].text}<br>
  Rank: ${e[0].rank}<br>
  Warrant: ${e[0].warrant}</p><hr>`);
  let total=0;
  e.forEach(x=>{
    total+=x.net;
    w.document.write(`<p>${x.date} — ${x.hours}h — £${x.net.toFixed(2)}</p>`);
    if(x.receipt) w.document.write(`<img src="${x.receipt}" width="300">`);
  });
  w.document.write(`<h2>Total £${total.toFixed(2)}</h2>`);
  w.print();
};

function switchScreen(s){
  screenCalc.style.display=s==='calc'?'block':'none';
  screenLog.style.display=s==='log'?'block':'none';
  screenSettings.style.display=s==='settings'?'block':'none';
  tabCalc.classList.toggle('active',s==='calc');
  tabLog.classList.toggle('active',s==='log');
  tabSettings.classList.toggle('active',s==='settings');
}

tabCalc.onclick=()=>switchScreen('calc');
tabLog.onclick=()=>switchScreen('log');
tabSettings.onclick=()=>switchScreen('settings');

force.onchange=loadRanks;
rank.onchange=loadPoints;
startTime.onchange=calculate;
finishTime.onchange=calculate;
otType.onchange=calculate;

date.valueAsDate=new Date();
loadRanks();
renderLog();
</script>
</body>
</html>
