<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Police OT</title>

<link
  href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css"
  rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>


<style>
:root{--blue:#0a3a8f}
*{box-sizing:border-box}
body{
margin:0;
font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial;
background:#f2f2f7;
padding-bottom:40px;
}
h1,h2{text-align:center;margin:12px 0}
label{font-size:.85rem;font-weight:600}
input,select,button{
width:100%;
padding:10px;
margin-top:6px;
border-radius:10px;
border:1px solid #ccc;
font-size:.9rem;
text-align:left;
}
.card{
max-width:420px;
margin:70px auto 24px;
background:#fff;
border-radius:16px;
padding:16px;
box-shadow:0 8px 20px rgba(0,0,0,.08);
}
.field.receipt{
  position:relative;
  display:flex;
  flex-direction:column;
}
button.primary{
background:var(--blue);
color:#fff;
border:none;
font-weight:700;
margin-top:12px;
}
.result{
background:#f5f5f7;
border-radius:12px;
padding:12px;
margin-top:12px;
}
.row{
display:flex;
justify-content:space-between;
margin:6px 0;
font-size:.9rem;
}
.entry{
background:#fff;
border-radius:12px;
padding:10px;
margin-top:10px;
font-size:.85rem;
}
.entry img{
max-width:100%;
border-radius:8px;
margin-top:6px;
}
.entry-actions{
display:flex;
gap:8px;
margin-top:6px;
}
.entry-actions button{
flex:1;
padding:6px;
font-size:.8rem;
}

/* MENU */
#menuBtn{
position:fixed;
top:12px;
right:12px;
width:44px;
height:44px;
border-radius:12px;
border:none;
background:var(--blue);
color:#fff;
font-size:22px;
z-index:2000;
}
#sideMenu{
position:fixed;
top:0;
left:-260px;
width:240px;
height:100%;
background:var(--blue);
padding:20px;
transition:left .3s;
z-index:1999;
}
#sideMenu h3{color:#fff;margin-top:40px}
#sideMenu button{
width:100%;
padding:12px;
border:none;
border-radius:10px;
margin:10px 0;
font-weight:700;
}

/* DISCLAIMER */
#disclaimer{
position:fixed;
inset:0;
background:rgba(0,0,0,.6);
display:flex;
align-items:center;
justify-content:center;
z-index:5000;
}
  
/* DISCLAIMER */
#disclaimer{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:5000;
}

/* Ensure disclaimer buttons receive clicks on mobile */
#disclaimer{
  pointer-events:auto;
}

#disclaimerBox{
  pointer-events:auto;
  position:relative;
  z-index:6000;
}


/* Fix disclaimer checkbox stealing clicks */
#disclaimer input[type="checkbox"]{
  width:auto;
  padding:0;
  margin-right:8px;
}


  /* ================= UNIFIED BUTTON STYLE ================= */

  /* Base button behaviour */
  button{
    appearance:none;
    -webkit-appearance:none;
    border-radius:12px;
    font-weight:700;
    cursor:pointer;
    transition:
      background-color .15s ease,
      color .15s ease,
      box-shadow .15s ease,
      transform .05s ease;
    box-shadow:0 2px 6px rgba(0,0,0,.08);
  }

  /* ALL buttons look like "Save Overtime" by default */
  button{
    background:var(--blue);
    color:#fff;
    border:none;
  }

  /* Hover / press feedback */
  button:hover{
    filter:brightness(.95);
  }

  button:active{
    transform:scale(.97);
    box-shadow:0 1px 3px rgba(0,0,0,.12);
  }

  /* Side menu buttons remain white */
  #sideMenu button{
    background:#fff;
    color:var(--blue);
  }

  /* Smaller action buttons in log */
  .entry-actions button{
    font-size:.8rem;
    padding:8px;
  }
/* ================= ENTRY BOX VISIBILITY ================= */

/* Main page cards */
.card{
  background:#fff;
  border:2px solid #d1d1d6;
}

/* Result summary boxes */
.result{
  background:#fff;
  border:2px solid #d1d1d6;
}

/* Log / saved entry boxes */
.entry{
  background:#fff;
  border:2px solid #d1d1d6;
}

/* Optional: slightly stronger separation between entries */
.entry + .entry{
  margin-top:14px;
}
/* ================= FORM FIELD COLOUR FIX ================= */

/* Text inputs, date, time, readonly fields */
input{
  background:#fff !important;
  color:#000;
  border:2px solid #d1d1d6;
}

/* Dropdowns / selects */
select{
  background:#fff !important;
  color:#000;
  border:2px solid #d1d1d6;
}

/* Remove mobile grey fill (iOS / Chrome) */
input:read-only{
  background:#fff !important;
}

/* Focus state (optional but clearer) */
input:focus,
select:focus{
  outline:none;
  border-color:var(--blue);
  box-shadow:0 0 0 2px rgba(10,58,143,.15);
}
/* ================= FIXED PAGE HEADERS ================= */

/* Page titles act as sticky app-style headers */
.card h2{
  position:sticky;
  top:0;
  margin:-16px -16px 12px -16px;
  padding:14px 64px 14px 16px; /* space on right for hamburger */
  background:var(--blue);
  color:#fff;
  font-size:1.1rem;
  z-index:1500;
  border-radius:16px 16px 0 0;
  display:flex;
  align-items:center;
}

/* Hamburger visually docked to title bar */
#menuBtn{
  position:fixed;
  top:14px;              /* aligns vertically with h2 */
  right:16px;
  height:36px;
  width:36px;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:2001;
}

    /* ================= REMOVE RECEIPT BUTTON ================= */

.remove-receipt{
  position:absolute;
  right:10px;
  top:38px;          
  background:#fff;
  color:#d32f2f;
  border:2px solid #d32f2f;
  border-radius:50%;
  width:24px;
  height:24px;
  font-size:14px;
  font-weight:700;
  display:none;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  padding:0;
}

.remove-receipt:hover{
  background:#d32f2f;
  color:#fff;
}

/* ================= DANGER BUTTON ================= */

button.danger{
  background:#d32f2f !important;
  color:#fff !important;
  border:none;
}

button.danger:hover{
  filter:brightness(.9);
}

button.danger:active{
  transform:scale(.96);
}

/* ================= DARK MODE ================= */

body.dark{
  background:#0f172a;
  color:#e5e7eb;
}

/* Cards */
body.dark .card{
  background:#111827;
  border-color:#374151;
}

/* Inputs & selects */
body.dark input,
body.dark select{
  background:#111827 !important;
  color:#e5e7eb;
  border-color:#374151;
}

/* Results & entries */
body.dark .result,
body.dark .entry{
  background:#111827;
  border-color:#374151;
}

/* Labels */
body.dark label{
  color:#d1d5db;
}

/* Headings */
body.dark .card h2{
  background:#1e40af;
}

/* Side menu */
body.dark #sideMenu{
  background:#020617;
}

/* Side menu buttons */
body.dark #sideMenu button{
  background:#111827;
  color:#e5e7eb;
}

/* Log images border */
body.dark .entry img{
  border:1px solid #374151;
}

/* Remove receipt button */
body.dark .remove-receipt{
  background:#111827;
}

/* Danger button stays red */
body.dark button.danger{
  background:#b91c1c !important;
}
body.dark .fc{
  background:#111827;
  color:#e5e7eb;
}

body.dark .fc-daygrid-day{
  background:#020617;
}

body.dark .fc-toolbar-title{
  color:#e5e7eb;
}
/* ================= CALENDAR SIZE ================= */

#calendar{
  margin-top:12px;
  min-height:380px;
}

@media (max-width:480px){
  #calendar{
    min-height:340px;
  }
}
  
</style>
</head>
  
<body>

<!-- DISCLAIMER -->
<div id="disclaimer">
<div id="disclaimerBox" style="background:#fff;border-radius:16px;padding:20px;max-width:360px;width:90%">
    <h2>Disclaimer</h2>
    <p style="font-size:.9rem;line-height:1.45">
      The figures used in this application are <b>not guaranteed to be 100% accurate</b>.<br><br>
      They are intended to be as close as possible and may be outdated,
      particularly following recent pay awards or changes.<br><br>
      This app is for guidance only and must not be relied upon as an official calculation.
    </p>
    <label style="display:flex;align-items:center;font-size:.85rem">
      <input type="checkbox" id="dontShowAgain" style="margin-right:8px">
      Donâ€™t show again
    </label>
    <button class="primary" id="acceptDisclaimerBtn">I Understand</button>
  </div>
</div>

<button id="menuBtn">â˜°</button>

<div id="sideMenu">
<h3>Menu</h3>
<button onclick="show('ot')">Police Overtime</button>
<button onclick="show('acting')">Acting Up</button>
<button onclick="show('log')">Log</button>
<button onclick="show('calendar')">Calendar</button>
<button onclick="toggleDarkMode()">ðŸŒ™ Dark Mode</button>
<button class="danger" onclick="clearAll()">Clear All Data</button>
</div>

<!-- ================= OVERTIME ================= -->
<div class="card" id="screen-ot">
<h2>Police Overtime</h2>

<div class="field">
<label>Force</label>
<select id="force">
<option value="met">Metropolitan Police</option>
<option value="other">Other Home Office Force</option>
</select>
</div>

<div class="field">
<label>Warrant Number</label>
<input id="warrant" placeholder="P123456">
</div>

<div class="field">
<label>Rank</label>
<select id="otRank">
<option value="PC">PC</option>
<option value="PS">PS</option>
</select>
</div>

<div class="field">
<label>Pay Point</label>
<select id="otPoint"></select>
</div>

<div class="field">
<label>Date</label>
<input type="date" id="otDate">
</div>

<div class="field">
<label>Start Time</label>
<input type="time" id="otStart">
</div>

<div class="field">
<label>Finish Time</label>
<input type="time" id="otFinish">
</div>

<div class="field">
<label>Total Hours</label>
<input id="otHours" readonly>
</div>

<div class="field">
<label>OT Rate</label>
<select id="otRate">
<option value="1.3333">Standard (1â…“)</option>
<option value="1.5">Rest Day (1Â½)</option>
<option value="2">Cancelled RD (Double)</option>
</select>
</div>

<div class="field">
<label>Expense</label>
<select id="expense">
<option value="0">None</option>
<option value="7.5">Breakfast Â£7.50</option>
<option value="7.5">Lunch Â£7.50</option>
<option value="15">Dinner Â£15.00</option>
</select>
</div>

<div class="field receipt">
  <label>Receipt</label>
  <input type="file" id="receipt" accept="image/*">

  <button
    type="button"
    class="remove-receipt"
    onclick="clearReceipt()"
    title="Remove receipt"
    aria-label="Remove receipt"
  >
    âœ•
  </button>
</div>

<div class="result">
  <div class="row"><span>Base Hourly</span><strong>Â£<span id="base">0.00</span></strong></div>
  <div class="row"><span>OT Hourly</span><strong>Â£<span id="ot">0.00</span></strong></div>
  <div class="row"><span>Gross</span><strong>Â£<span id="gross">0.00</span></strong></div>
  <div class="row"><span>Tax & NI</span><strong>Â£<span id="tax">0.00</span></strong></div>
  <div class="row"><span>Total</span><strong>Â£<span id="total">0.00</span></strong></div>
</div>

<button class="primary" onclick="saveOTStore()">Save Overtime</button>
<button onclick="exportOTClaimPDF()">Export Claim (PDF)</button>
<button onclick="exportOTCalendar()">Export to Calendar</button>
</div> 

<!-- ================= ACTING UP ================= -->
<div class="card" id="screen-acting" style="display:none">
<h2>Acting Up Allowance</h2>

<div class="field">
<label>Force</label>
<select id="actForce">
<option value="met">Metropolitan Police</option>
<option value="other">Other Home Office Force</option>
</select>
</div>

<div class="field">
<label>Current Rank</label>
<select id="curRank">
<option value="PC">PC</option>
<option value="PS">PS</option>
</select>
</div>

<div class="field">
<label>Current Pay Point</label>
<select id="curPoint"></select>
</div>

<div class="field">
<label>Acting Rank</label>
<select id="actRank">
<option value="PS">Police Sergeant</option>
<option value="INSP">Inspector</option>
</select>
</div>

<div class="field">
<label>Date</label>
<input type="date" id="actDate">
</div>

<div class="field">
<label>Start Time</label>
<input type="time" id="actStart">
</div>

<div class="field">
<label>Finish Time</label>
<input type="time" id="actFinish">
</div>

<div class="field">
<label>Total Hours</label>
<input id="actHours" readonly>
</div>

<div class="result">
<div class="row"><span>Hourly Difference</span><strong>Â£<span id="diff">0.00</span></strong></div>
<div class="row"><span>Gross</span><strong>Â£<span id="actGross">0.00</span></strong></div>
<div class="row"><span>Tax & NI</span><strong>Â£<span id="actTax">0.00</span></strong></div>
<div class="row"><span>Total</span><strong>Â£<span id="actTotal">0.00</span></strong></div>
</div>

<button class="primary" onclick="saveActing()">Save Acting Up</button>
<button onclick="exportActingCalendar()">Export to Calendar</button>
</div>

<!-- ================= LOG ================= -->
<div class="card" id="screen-log" style="display:none">
<h2>Log</h2>
<div id="log"></div>
</div>

<!-- ================= CALENDAR ================= -->
<div class="card" id="screen-calendar" style="display:none">
  <h2>Calendar</h2>

  <div id="calendar"></div>

  <div class="field">
    <label>Add Entry</label>
    <select id="calType">
      <option value="Leave">Annual Leave</option>
      <option value="Shift">Shift / Schedule</option>
    </select>
  </div>

  <div class="field">
    <input type="date" id="calDate">
  </div>

  <div class="field">
    <input id="calNote" placeholder="Optional note">
  </div>

  <button onclick="addCalendarEntry()">Add to Calendar</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>  
  
<script>
/* ================= CONFIG ================= */
const APP_VERSION = "1.0.0";
const STORE_OT  = "policeOT_overtime";
const STORE_ACT = "policeOT_acting";
const STORE_CAL = "policeOT_calendar";
const LONDON = 9738;



/* PAY SCALES */
const PAY={
PC:[31646,32472,33789,35106,37737,43038,50256],
PS:[43698,45409,47172],
INSP:[63768,65505,67236,68982]
};

const qs = i => document.getElementById(i);

/* ================= STORE HELPERS ================= */

const loadOTStore = () =>
  JSON.parse(localStorage.getItem(STORE_OT) || "[]");

const saveOTStore = d =>
  localStorage.setItem(STORE_OT, JSON.stringify(d));

const loadActStore = () =>
  JSON.parse(localStorage.getItem(STORE_ACT) || "[]");

const saveActStore = d =>
  localStorage.setItem(STORE_ACT, JSON.stringify(d));


const loadCal = () =>
  JSON.parse(localStorage.getItem(STORE_CAL) || "[]");

const saveCal = d =>
  localStorage.setItem(STORE_CAL, JSON.stringify(d));


/* DISCLAIMER */
function acceptDisclaimer(){
  alert("Disclaimer accepted");
  localStorage.setItem("disclaimerAccepted", JSON.stringify({
    version: APP_VERSION,
    dontShow: qs("dontShowAgain").checked
  }));
  qs("disclaimer").style.display = "none";
}

document.addEventListener("DOMContentLoaded", () => {
  const d = JSON.parse(localStorage.getItem("disclaimerAccepted") || "null");

  if (
    d &&
    d.version === APP_VERSION &&
    d.dontShow &&
    qs("disclaimer")
  ) {
    qs("disclaimer").style.display = "none";
  }
});


/* TIME */
function round15(m){return Math.round(m/15)*15}
function hoursBetween(s,f){
if(!s||!f)return"";
let [sh,sm]=s.split(":").map(Number);
let [fh,fm]=f.split(":").map(Number);
let m=(fh*60+fm)-(sh*60+sm);
if(m<0)m+=1440;
return(round15(m)/60).toFixed(2);
}

/* OVERTIME */
function loadOTStorePoints(){
qs("otPoint").innerHTML="";
PAY[qs("otRank").value].forEach((_,i)=>qs("otPoint").add(new Option(i+1,i)));
calcOT();
}
qs("otRank").onchange=loadOTStorePoints;
loadOTStorePoints();

function calcOT(){
qs("otHours").value=hoursBetween(qs("otStart").value,qs("otFinish").value);
if(!qs("otHours").value)return;
let annual=PAY[qs("otRank").value][qs("otPoint").value]+(qs("force").value==="met"?LONDON:0);
let base=annual/52/40;
let ot=base*qs("otRate").value;
let gross=(ot-base)*qs("otHours").value;
let tax=gross*(annual>50270?0.42:0.28);
qs("base").textContent=base.toFixed(2);
qs("ot").textContent=ot.toFixed(2);
qs("gross").textContent=gross.toFixed(2);
qs("tax").textContent=tax.toFixed(2);
qs("total").textContent=(gross-tax).toFixed(2);
}
["otStart","otFinish","otRate","otPoint","force"].forEach(i=>qs(i).onchange=calcOT);

/* ACTING */
function loadActStorePoints(){
qs("curPoint").innerHTML="";
PAY[qs("curRank").value].forEach((_,i)=>qs("curPoint").add(new Option(i+1,i)));
calcActing();
}
qs("curRank").onchange=loadActStorePoints;
loadActStorePoints();

function calcActing(){
qs("actHours").value=hoursBetween(qs("actStart").value,qs("actFinish").value);
if(!qs("actHours").value)return;
let cur=PAY[qs("curRank").value][qs("curPoint").value]+(qs("actForce").value==="met"?LONDON:0);
let act=qs("actRank").value==="PS"?PAY.PS[0]:PAY.INSP[0];
act+=(qs("actForce").value==="met"?LONDON:0);
let diff=(act/52/40)-(cur/52/40);
let gross=diff*qs("actHours").value;
let tax=gross*(cur>50270?0.42:0.28);
qs("diff").textContent=diff.toFixed(2);
qs("actGross").textContent=gross.toFixed(2);
qs("actTax").textContent=tax.toFixed(2);
qs("actTotal").textContent=(gross-tax).toFixed(2);
}
["actStart","actFinish","curPoint","actRank","actForce"].forEach(i=>qs(i).onchange=calcActing);

/* LOG */
function load(){
  return [
    ...loadOTStore(),
    ...loadActStore(),
    ...loadCal()
  ];
}


let editingIndex=null;

function saveOTStore(){
  calcOT();

  const img = qs("receipt").files[0]
    ? URL.createObjectURL(qs("receipt").files[0])
    : null;

  const d = loadOTStore();
  d.push({
    type:"Overtime",
    date:qs("otDate").value,
    hours:qs("otHours").value,
    expense:qs("expense").value,
    receipt:img
  });

  saveOTStore(d);
  renderLog();
  show("log");
}

function saveActing(){
  calcActing();

  const d = loadActStore();
  d.push({
    type:"Acting Up",
    date:qs("actDate").value,
    hours:qs("actHours").value
  });

  saveActStore(d);
  renderLog();
  show("log");
}

function renderLog(){
qs("log").innerHTML="";
load().forEach((e,i)=>{
if(editingIndex===i){
qs("log").innerHTML+=`
<div class="entry">
<label>Date</label>
<input type="date" id="editDate" value="${e.date}">
<label>Hours</label>
<input id="editHours" value="${e.hours}">
${e.expense!==undefined?`
<label>Expense</label>
<input id="editExpense" value="${e.expense}">
`:""}
<div class="entry-actions">
<button onclick="saveEdit(${i})">Save</button>
<button onclick="cancelEdit()">Cancel</button>
</div>
</div>`;
}else{
qs("log").innerHTML+=`
<div class="entry">
<b>${e.type}</b><br>${e.date}<br>${e.hours} hrs
${e.expense?`<br>Expense Â£${e.expense}`:""}
${e.receipt?`<img src="${e.receipt}">`:""}
<div class="entry-actions">
<button onclick="editEntry(${i})">Edit</button>
<button onclick="del(${i})">Delete</button>
</div>
</div>`;
}
});
}

function editEntry(i){
editingIndex=i;
renderLog();
}
function cancelEdit(){
editingIndex=null;
renderLog();
}
function saveEdit(i){
  const all = load();

  all[i].date = qs("editDate").value;
  all[i].hours = qs("editHours").value;

  if(all[i].expense !== undefined){
    all[i].expense = qs("editExpense").value;
  }

  const ot  = all.filter(e => e.type === "Overtime");
  const act = all.filter(e => e.type === "Acting Up");
  const cal = all.filter(e => !["Overtime","Acting Up"].includes(e.type));

  saveOTStore(ot);
  saveActStore(act);
  saveCal(cal);

  editingIndex = null;
  renderLog();
}

function del(i){
  const all = load();
  all.splice(i,1);

  const ot  = all.filter(e => e.type === "Overtime");
  const act = all.filter(e => e.type === "Acting Up");
  const cal = all.filter(e => !["Overtime","Acting Up"].includes(e.type));

  saveOTStore(ot);
  saveActStore(act);
  saveCal(cal);

  renderLog();
}

function clearAll(){
  const msg =
`âš ï¸ CLEAR ALL DATA

This will permanently delete:
â€¢ All overtime entries
â€¢ All acting up entries
â€¢ The entire log
â€¢ Any attached receipts
â€¢ All calculated totals

This action CANNOT be undone.

Do you want to continue?`;

  if(!confirm(msg)) return;

  /* ===== CLEAR STORED DATA ===== */
localStorage.removeItem(STORE_OT);
localStorage.removeItem(STORE_ACT);
localStorage.removeItem(STORE_CAL);

  /* ===== OVERTIME ===== */
  [
    "force","warrant","otRank","otPoint","otDate",
    "otStart","otFinish","otRate","expense"
  ].forEach(id => {
    if(qs(id)){
      qs(id).value =
        qs(id).tagName === "SELECT"
          ? qs(id).options[0].value
          : "";
    }
  });

  qs("otHours").value = "";
  ["base","ot","gross","tax","total"].forEach(id => qs(id).textContent = "0.00");

  /* Receipt */
  qs("receipt").value = "";
  document.querySelector(".remove-receipt").style.display = "none";

  /* ===== ACTING UP ===== */
  [
    "actForce","curRank","curPoint","actRank",
    "actDate","actStart","actFinish"
  ].forEach(id => {
    if(qs(id)){
      qs(id).value =
        qs(id).tagName === "SELECT"
          ? qs(id).options[0].value
          : "";
    }
  });

  qs("actHours").value = "";
  ["diff","actGross","actTax","actTotal"].forEach(id => qs(id).textContent = "0.00");

  /* ===== LOG ===== */
  qs("log").innerHTML = "";
  editingIndex = null;

  /* Rebuild pay point dropdowns */
loadOTStorePoints();
loadActStorePoints();

  alert("All data has been cleared.");
}

/* NAV */
function show(s){
  ["ot","acting","log","calendar"].forEach(x =>
    qs("screen-"+x).style.display="none"
  );

  qs("screen-"+s).style.display="block";
  qs("sideMenu").style.left="-260px";

  if(s==="calendar") loadCalendar();
}
  qs("menuBtn").onclick = () => {
  qs("sideMenu").style.left =
    qs("sideMenu").style.left === "0px" ? "-260px" : "0px";
};

  
/* ================= CALENDAR EXPORT ================= */

function downloadICS(filename, content){
  const blob = new Blob([content], { type: "text/calendar;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function buildICS({ title, date, start, finish, description }){
  const pad = n => String(n).padStart(2, "0");

  const toICSDate = (d, t) => {
    const [y,m,day] = d.split("-");
    const [h,min] = t.split(":");
    return `${y}${pad(m)}${pad(day)}T${pad(h)}${pad(min)}00`;
  };

  return `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Police OT//EN
BEGIN:VEVENT
UID:${Date.now()}@policeot
DTSTAMP:${toICSDate(date, start)}
DTSTART:${toICSDate(date, start)}
DTEND:${toICSDate(date, finish)}
SUMMARY:${title}
DESCRIPTION:${description}
END:VEVENT
END:VCALENDAR`;
}

/* ===== OVERTIME CALENDAR EXPORT ===== */
function exportOTCalendar(){
  if(!qs("otDate").value || !qs("otStart").value || !qs("otFinish").value){
    alert("Please enter date, start time and finish time");
    return;
  }

  // Ensure latest calculations
  calcOT();

  const expenseSelect = qs("expense");
  const expenseText =
    expenseSelect.value === "0"
      ? "None"
      : expenseSelect.options[expenseSelect.selectedIndex].text;

  const ics = buildICS({
    title: "Police Overtime",
    date: qs("otDate").value,
    start: qs("otStart").value,
    finish: qs("otFinish").value,
    description:
`Overtime Duty

Hours: ${qs("otHours").value}
OT Rate: Â£${qs("ot").textContent} / hr
Gross: Â£${qs("gross").textContent}
Tax & NI: Â£${qs("tax").textContent}
Net Pay: Â£${qs("total").textContent}

Notes: ${expenseText}`
  });

  downloadICS("police-overtime.ics", ics);
}
  
/* ===== ACTING UP CALENDAR EXPORT ===== */
function exportActingCalendar(){
  if(!qs("actDate").value || !qs("actStart").value || !qs("actFinish").value){
    alert("Please enter date, start time and finish time");
    return;
  }

  // Ensure latest calculations
  calcActing();

  const ics = buildICS({
    title: "Acting Up Duty",
    date: qs("actDate").value,
    start: qs("actStart").value,
    finish: qs("actFinish").value,
    description:
`Acting Up Duty

Hours: ${qs("actHours").value}
Hourly Difference: Â£${qs("diff").textContent}
Gross: Â£${qs("actGross").textContent}
Tax & NI: Â£${qs("actTax").textContent}
Net Pay: Â£${qs("actTotal").textContent}`
  });

  downloadICS("acting-up.ics", ics);
}
/* ===== OVERTIME CLAIM PDF EXPORT ===== */
function exportOTClaimPDF(){
  if(!qs("otDate").value || !qs("otStart").value || !qs("otFinish").value){
    alert("Please complete the overtime details first");
    return;
  }

  // Ensure latest calculations at click time
  calcOT();

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  let y = 20;

  doc.setFontSize(16);
  doc.text("Overtime Claim", 20, y);
  y += 10;

  doc.setFontSize(11);

  const forceName =
    qs("force").value === "met"
      ? "Metropolitan Police"
      : "Home Office Force";

  doc.text(`Force: ${forceName}`, 20, y); y += 8;
  doc.text(`Warrant Number: ${qs("warrant").value || "â€”"}`, 20, y); y += 8;
  doc.text(`Date: ${qs("otDate").value}`, 20, y); y += 8;

  doc.text(`Start Time: ${qs("otStart").value}`, 20, y); y += 8;
  doc.text(`Finish Time: ${qs("otFinish").value}`, 20, y); y += 8;
  doc.text(`Hours: ${qs("otHours").value}`, 20, y); y += 10;

 const expenseSelect = qs("expense");
const expenseText =
  expenseSelect.value === "0"
    ? "None"
    : expenseSelect.options[expenseSelect.selectedIndex].text;

doc.text(`Expenses: ${expenseText}`, 20, y);
  y += 12;

  const file = qs("receipt").files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = e => {
      const imgType = file.type.includes("png") ? "PNG" : "JPEG";
      doc.addImage(e.target.result, imgType, 20, y, 170, 80);
      doc.save("overtime-claim.pdf");
    };
    reader.readAsDataURL(file);
  } else {
    doc.save("overtime-claim.pdf");
  }
}
function clearReceipt(){
  const input = qs("receipt");
  input.value = "";
  document.querySelector(".remove-receipt").style.display = "none";
}
  
const receiptInput = qs("receipt");
if(receiptInput){
  receiptInput.addEventListener("change", () => {
    document.querySelector(".remove-receipt").style.display =
      receiptInput.files.length ? "flex" : "none";
  });
}
  
/* ================= DARK MODE ================= */

function toggleDarkMode(){
  const isDark = document.body.classList.toggle("dark");
  localStorage.setItem("darkMode", isDark ? "on" : "off");
}

/* Load preference */
(function(){
  if(localStorage.getItem("darkMode") === "on"){
    document.body.classList.add("dark");
  }
})();


/* ================= CALENDAR ================= */

let calendarInstance = null;

function loadCalendar(){
  const calendarEl = qs("calendar");

  if(calendarInstance){
    calendarInstance.destroy();
  }

  const events = load().map(e => ({
    title:
      e.type === "Overtime" ? `OT (${e.hours}h)` :
      e.type === "Acting Up" ? `Acting (${e.hours}h)` :
      e.note || e.type,
    start: e.date,
    allDay: true,
    color:
      e.type === "Overtime" ? "#2563eb" :
      e.type === "Acting Up" ? "#16a34a" :
      e.type === "Leave" ? "#ca8a04" :
      "#6b7280"
  }));

  calendarInstance = new FullCalendar.Calendar(calendarEl,{
    initialView:"dayGridMonth",
    height:"auto",
    firstDay:1,
    events
  });

  calendarInstance.render();
}

function addCalendarEntry(){
  if(!qs("calDate").value){
    alert("Please select a date");
    return;
  }

  const d = loadCal();
  d.push({
    type: qs("calType").value,
    date: qs("calDate").value,
    note: qs("calNote").value
  });

  saveCal(d);

  qs("calDate").value = "";
  qs("calNote").value = "";

  loadCalendar();
}

  /* ================= STORAGE MIGRATION ================= */
(function migrateOldStore(){
  const old = JSON.parse(localStorage.getItem("policeOT") || "null");
  if(!old) return;

  const ot  = [];
  const act = [];
  const cal = [];

  old.forEach(e => {
    if(e.type === "Overtime") ot.push(e);
    else if(e.type === "Acting Up") act.push(e);
    else cal.push(e);
  });

  localStorage.setItem("policeOT_overtime", JSON.stringify(ot));
  localStorage.setItem("policeOT_acting", JSON.stringify(act));
  localStorage.setItem("policeOT_calendar", JSON.stringify(cal));

  localStorage.removeItem("policeOT");
})();

/* ===== DISCLAIMER BUTTON FIX (MOBILE SAFE) ===== */
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("acceptDisclaimerBtn");

  if (!btn) return;

  btn.addEventListener("touchend", e => {
    e.preventDefault();
    acceptDisclaimer();
  });

  btn.addEventListener("click", e => {
    e.preventDefault();
    acceptDisclaimer();
  });
});
</script>

</body>
</html>
