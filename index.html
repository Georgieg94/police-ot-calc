<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Police OT Calc</title>
  <style>
    body {font-family: Arial, sans-serif;background:#f4f6f8;margin:0;padding:16px;display:flex;justify-content:center;}
    .card {background:#fff;max-width:420px;width:100%;padding:20px;border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,0.1);}    
    h1{text-align:center;font-size:1.4rem;}
    label{display:block;margin-top:12px;font-weight:bold;}
    select,input,button{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #ccc;font-size:1rem;}
    button{background:#1e3a8a;color:#fff;border:none;margin-top:12px;}
    .result{margin-top:16px;background:#f0f2f5;padding:12px;border-radius:10px;}
    .row{display:flex;justify-content:space-between;margin:6px 0;}
    img.thumb{width:60px;margin:4px;border-radius:6px;}
    #lockScreen{position:fixed;inset:0;background:#1e3a8a;display:flex;align-items:center;justify-content:center;color:#fff;z-index:9999;}
    #lockBox{background:#fff;color:#000;padding:20px;border-radius:12px;width:280px;text-align:center;}
  </style>
</head>
<body>

<div id="lockScreen" style="display:none;">
  <div id="lockBox">
    <h2>Police OT Calc</h2>
    <input type="password" id="pinInput" maxlength="4" inputmode="numeric" />
    <button id="unlockBtn">Unlock</button>
  </div>
</div>

<div class="card" id="app">
<h1>Police OT Calc</h1>

<label>Force</label>
<select id="force"><option value="met">Metropolitan Police</option><option value="other">Other Home Office Force</option></select>

<label>Rank</label>
<select id="rank"></select>

<label>Pay Point</label>
<select id="payPoint"></select>

<label>Date</label>
<input type="date" id="otDate">

<label>Hours Worked</label>
<input type="number" id="hours" value="9" min="0">

<label>Overtime Type</label>
<select id="otType"><option value="1.3333">Standard (1⅓)</option><option value="1.5">Rest Day (1½)</option><option value="2">Cancelled RD (Double)</option></select>

<div class="result">
  <div class="row"><span>Base Hourly</span><strong>£<span id="base">0.00</span></strong></div>
  <div class="row"><span>OT Hourly</span><strong>£<span id="ot">0.00</span></strong></div>
  <div class="row"><span>Gross</span><strong>£<span id="gross">0.00</span></strong></div>
  <div class="row"><span>Tax & NI</span><strong>-£<span id="deductions">0.00</span></strong></div>
  <div class="row"><span>Net Pay</span><strong>£<span id="net">0.00</span></strong></div>
</div>

<button id="saveOt">Save Overtime</button>
<button id="exportCal">Add OT to Calendar</button>
<button id="exportPdf">Export PDF Claim</button>

<label>Attach Receipt</label>
<input type="file" id="receipt" accept="image/*">

<div class="result">
  <h3>Overtime Log</h3>
  <select id="viewMode"><option value="day">By Day</option><option value="week">By Week</option><option value="month">By Month</option></select>
  <div id="calendarList"></div>
</div>
</div>

<script>
// ===== SECURITY =====
const PIN_KEY = 'police_ot_pin';
const LOCK_TIMEOUT = 60000;
let lockTimer;

const lockScreen = document.getElementById('lockScreen');
const app = document.getElementById('app');
const pinInput = document.getElementById('pinInput');
const unlockBtn = document.getElementById('unlockBtn');

function lockApp(){ lockScreen.style.display='flex'; app.style.display='none'; }
function unlockApp(){ lockScreen.style.display='none'; app.style.display='block'; resetTimer(); }
function resetTimer(){ clearTimeout(lockTimer); lockTimer=setTimeout(lockApp,LOCK_TIMEOUT); }

if(!localStorage.getItem(PIN_KEY)){
  const pin = prompt('Set a 4-digit PIN');
  if(pin) localStorage.setItem(PIN_KEY,pin);
}

unlockBtn.onclick = () => {
  if(pinInput.value === localStorage.getItem(PIN_KEY)) unlockApp();
  else alert('Incorrect PIN');
};

['click','keydown','touchstart'].forEach(e=>document.addEventListener(e,resetTimer));
lockApp();

// ===== CORE =====
const WEEKLY_HOURS = 40;
const STORE_KEY = 'police_ot_entries';

const PAY = {
  met:{"Police Constable":{1:31646,2:32472,3:33789,4:35106,5:37737,6:43038,7:50256},"Police Sergeant":{2:53568,3:54660,4:56208}},
  other:{"Police Constable":{1:31646,2:32472,3:33789,4:35106,5:37737,6:43038,7:50256},"Police Sergeant":{2:53568,3:54660,4:56208}}
};

const forceEl = document.getElementById('force');
const rankEl = document.getElementById('rank');
const pointEl = document.getElementById('payPoint');
const hoursEl = document.getElementById('hours');
const otTypeEl = document.getElementById('otType');

const baseEl = document.getElementById('base');
const otEl = document.getElementById('ot');
const grossEl = document.getElementById('gross');
const deductionsEl = document.getElementById('deductions');
const netEl = document.getElementById('net');

function loadRanks(){
  rankEl.innerHTML='';
  Object.keys(PAY[forceEl.value]).forEach(r=>rankEl.add(new Option(r,r)));
  loadPayPoints();
}

function loadPayPoints(){
  pointEl.innerHTML='';
  Object.keys(PAY[forceEl.value][rankEl.value]).forEach(p=>pointEl.add(new Option(p,p)));
  calculate();
}

function calculate(){
  const annual = PAY[forceEl.value][rankEl.value][pointEl.value];
  if(!annual) return;
  const base = annual/52/WEEKLY_HOURS;
  const otRate = base*Number(otTypeEl.value);
  const hrs = Number(hoursEl.value)||0;
  const gross = otRate*hrs;
  const higher = annual>50270;
  const deductions = gross*((higher?0.4:0.2)+(higher?0.02:0.08));
  const net = gross-deductions;
  baseEl.textContent=base.toFixed(2);
  otEl.textContent=otRate.toFixed(2);
  grossEl.textContent=gross.toFixed(2);
  deductionsEl.textContent=deductions.toFixed(2);
  netEl.textContent=net.toFixed(2);
}

function getEntries(){ return JSON.parse(localStorage.getItem(STORE_KEY)||'[]'); }
function saveEntry(e){ const a=getEntries(); a.push(e); localStorage.setItem(STORE_KEY,JSON.stringify(a)); }

function fileToBase64(file){ return new Promise(res=>{const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file);}); }

function renderCalendarView(){
  const list = document.getElementById('calendarList');
  const mode = document.getElementById('viewMode').value;
  list.innerHTML='';
  const grouped={};
  getEntries().forEach(e=>{
    const d=new Date(e.date);
    const key = mode==='day'?d.toLocaleDateString():mode==='week'?`Week of ${d.toLocaleDateString()}`:d.toLocaleString('default',{month:'long',year:'numeric'});
    grouped[key]??={h:0,n:0};
    grouped[key].h+=e.hours; grouped[key].n+=e.net;
  });
  Object.keys(grouped).forEach(k=>list.innerHTML+=`<div class='row'><span>${k} • ${grouped[k].h}h</span><strong>£${grouped[k].n.toFixed(2)}</strong></div>`);
}

// ===== EVENTS =====
forceEl.onchange = loadRanks;
rankEl.onchange = loadPayPoints;
payPoint.onchange = calculate;
hoursEl.oninput = calculate;
otTypeEl.onchange = calculate;

saveOt.onclick = async()=>{
  if(!Number(grossEl.textContent)) return alert('Nothing to save');
  let receiptData=null;
  if(receipt.files[0]) receiptData=await fileToBase64(receipt.files[0]);
  saveEntry({date:otDate.value,hours:Number(hoursEl.value),net:Number(netEl.textContent),receipt:receiptData});
  renderCalendarView();
};

exportCal.onclick = ()=>{
  const entries=getEntries();
  if(!entries.length) return alert('No overtime');
  let ics='BEGIN:VCALENDAR\nVERSION:2.0\n';
  entries.forEach(e=>{
    const d=new Date(e.date).toISOString().replace(/[-:]/g,'').split('.')[0];
    ics+=`BEGIN:VEVENT\nDTSTART:${d}\nSUMMARY:Police OT (${e.hours}h)\nEND:VEVENT\n`;
  });
  ics+='END:VCALENDAR';
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([ics],{type:'text/calendar'}));
  a.download='police-overtime.ics';
  a.click();
};

exportPdf.onclick = ()=>{
  const w=window.open('','_blank');
  let total=0;
  w.document.write('<h2>Police OT Claim</h2>');
  getEntries().forEach(e=>{ total+=e.net; w.document.write(`<p>${e.date} — ${e.hours}h — £${e.net.toFixed(2)}</p>`); if(e.receipt) w.document.write(`<img src='${e.receipt}' width='300'>`); });
  w.document.write(`<h3>Total £${total.toFixed(2)}</h3>`);
  w.print();
};

window.onload = ()=>{ otDate.valueAsDate=new Date(); loadRanks(); renderCalendarView(); };
</script>
</body>
</html>
